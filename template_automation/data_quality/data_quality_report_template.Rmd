---
title: |
  | FY`r params$fiscal_yr` EXPENDITURE REPORT 
  | DATA QUALITY REPORT 
  | `r params$ou` 
output: pdf_document
header-includes: 
  - \usepackage{longtable}
  - \usepackage{booktabs}
  - \usepackage{float}
  - \usepackage{colortbl}
  - \usepackage{xcolor}
  - \usepackage{multirow}

params:
  ou: "Tanzania"
  fiscal_yr: 2020
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(warning = FALSE)
knitr::opts_chunk$set(message = FALSE)
knitr::opts_chunk$set(echo = FALSE)
```

```{r r-setup, include=FALSE}
library(kableExtra)
library(glamr)
library(gophr)
library(glue)
library(tidyverse)
library(formattable)

source('data_quality_source.R')

########  Load Data #####################################
df_fsd <- read_csv("temp/df_fsd.csv")
df_msd <- read_csv("temp/df_msd.csv")

fsd_ou <- df_fsd %>% filter(operatingunit == params$ou)

msd_ou <- df_msd %>% filter(operatingunit == params$ou)

df_budg_exp<- fsd_ou %>%
  check_budg_exp() %>% 
  ungroup()

df_other <- #df_fsd %>%
  fsd_ou %>%
  percent_other_check() %>% 
  ungroup()

df_pm <- percent_pm_check(fsd_ou) %>%
  ungroup()

df_perc_exp_im <- exp_perc_budg_check_im(fsd_ou) %>%
  ungroup()

df_perc_exp_pa<- exp_perc_budg_check_pa(fsd_ou) %>%
  ungroup()

total_num_mechs <- length(unique(df_fsd$mech_code))
uniq_pe_im <- length(unique(df_perc_exp_im$mech_code))
uniq_pe_pa <- length(unique(df_perc_exp_pa$mech_code))

uniq_budg_exp <- length(unique(df_budg_exp$mech_code))
uniq_other <-length(unique(df_other$mech_code))
uniq_pm <- length(unique(df_pm$mech_code))

# perc_exp_good <- na.omit(df_perc_exp[df_perc_exp$perc_exp >= 0.9 & df_perc_exp$perc_exp <=1.1, ])

# good_perc_exp <- length(unique(perc_exp_good$mech_code))
```

# Introduction
Post Q4 pre-clean data release the Expenditure Analysis team ran 5 data checks to ensure data quality of the IP submitted templates. The EA team performed the following checks and compiled results for `r params$ou`.  The errors listed below are NOT required to address and are meant to flag potential issues/concerns for further investigation if and as desired.   The mission can determine any subsequent action based on these findings; however, we recommend reaching out to the partner for any concerning issues to have them correct their template and re-submit to DATIM when it reopens for the cleaning window from December 1-17, 2021.

Data quality checks performed include: 
\begin{itemize}
  \item Percent variance between the FAST budget and reported expenditures
  \item Percent of expenditures categorized with the cost category: sub-cost category “Other: Other”
  \item Percent expenditures of the FAST budget
  \item Cross data validation between select MER indicators and expenditures
\end{itemize}

# EXPENDITURE AS A PERCENTAGE OF BUDGET
The following table shows mechanisms that spent less than 80% or more than 120% of their budget. Missions may consider following up with partners to ensure 1.) reporting is accurate and there have been no errors, and/or 2.) ensure that they have access to rationale/context for the apparent misalignment between expenditure and budget.  This will be especially important for any IMs with program performance concerns. 

```{r, echo=FALSE}
col_perc_exp_im <- c("Mechanism Code", "Mechanism Name", 
                  "Total Expenditure", "Total Budgeted", "% Total Expenditures of Budget")

if (uniq_pe_im !=0){
  df_pe_im <- df_perc_exp_im %>%
  mutate(sum_fast = currency(sum_fast)) %>%
  mutate(sum_exp = currency(sum_exp)) %>%
  mutate(perc_exp = percent(perc_exp)) %>%
  mutate(perc_exp = as.character(perc_exp))
df_pe_im$perc_exp[is.na(df_pe_im$perc_exp)] <- '-'

df_pe_im %>%
  kbl(format = "latex", col.names = col_perc_exp_im, longtable=T,
      booktabs = T, escape=T, caption = "Expenditure as Percent of Budget, IM-level") %>%
  kable_paper(latex_options = c("hold_position", "repeat_header"),
              font_size = 8)%>%
  # https://tex.stackexchange.com/questions/98955/auto-resize-tabular-row-height
  row_spec(0, extra_latex_after = "[0.7cm]") %>%
  column_spec(1, width = '5em') %>%
  column_spec(2, width = '15em') %>%
  column_spec(3, width = '5em') %>%
  collapse_rows(columns = 1:2, valign="top")
} else{
    data.frame(list("No Mechanisms were flagged")) %>% 
    kbl(format = "latex", col.names = list("Note:"))%>%
    kable_paper(latex_options = c("hold_position"))
}




```
## Expenditure as Percent of Budget, Program Area-level
```{r, echo=FALSE}
col_perc_exp_pa <- c("Mechanism Code", "Mechanism Name", "Program Area",
                  "Total Expenditure", "Total Budgeted", "% Total Expenditures of Budget")

if (uniq_pe_pa != 0){
  df_pe_pa <- df_perc_exp_pa %>%
  mutate(sum_fast = currency(sum_fast)) %>%
  mutate(sum_exp = currency(sum_exp)) %>%
  mutate(perc_exp = percent(perc_exp)) %>%
  mutate(perc_exp = as.character(perc_exp))
df_pe_pa$perc_exp[is.na(df_pe_pa$perc_exp)] <- '-'

df_pe_pa %>%
  kbl(format = "latex", col.names = col_perc_exp_pa, longtable=T,
      booktabs = T, escape=T, caption = "Expenditure as Percent of Budget, Program Area-level") %>%
  kable_paper(latex_options = c("hold_position", "repeat_header"),
              font_size = 8)%>%
  # https://tex.stackexchange.com/questions/98955/auto-resize-tabular-row-height
  row_spec(0, extra_latex_after = "[0.7cm]") %>%
  column_spec(1, width = '5em') %>%
  column_spec(2, width = '15em') %>%
  column_spec(3, width = '5em') %>%
  column_spec(6, width='5em') %>%
  collapse_rows(columns = 1:2, valign="top")
} else{
    data.frame(list("No Mechanisms were flagged")) %>% 
    kbl(format = "latex", col.names = list("Note:"))%>%
    kable_paper(latex_options = c("hold_position"))
}
```
# PERCENT VARIANCE BETWEEN THE FAST BUDGET AND REPORTED EXPENDITURES


```{r, echo = FALSE}
budg_exp_title<- glue("Mechanisms with Expenditures Matching Budget FY{params$fiscal_yr}")
col_names <- c("Mech code", "Mechanism Name", "Intervention",
               "Total Planned Budget", "Total Expenditure")
if (uniq_budg_exp !=0){
  df_budg_exp %>%
  select(-diff) %>%
  mutate(sum_fast = currency(sum_fast)) %>%
  mutate(sum_exp = currency(sum_exp)) %>%
  mutate(intervention = cell_spec(intervention, 
                                  bold=df_budg_exp$intervention == " TOTAL interventions")) %>%
  mutate(sum_fast = cell_spec(sum_fast, 
                                  bold=df_budg_exp$intervention == " TOTAL interventions")) %>%
  mutate(sum_exp = cell_spec(sum_exp, 
                                  bold=df_budg_exp$intervention == " TOTAL interventions")) %>%
  kbl(format = "latex", caption = budg_exp_title, col.names = col_names, booktabs=T, escape=FALSE) %>%
  kable_paper(latex_options= c("hold_position")) %>% 
  column_spec(1, width = '3em') %>%
  column_spec(2, width = '15em') %>%
  column_spec(3, width = '7em') %>%
  collapse_rows (columns = 1:2, valign="top")
} else{
  data.frame(list("No Mechanisms were flagged")) %>% 
  kbl(format = "latex", col.names = list("Note:"))%>%
  kable_paper(latex_options = c("hold_position"))
}

```

# PERCENT OF “OTHER: OTHER” EXPENDITURES
If a mechanism has more than 10\% of total expenditures under the cost category: sub-cost category “Other: Other” it is flagged below. These should be reviewed by the mechanism and recategorized if possible. 

```{r, echo=FALSE}
col_other <- c("Operating Unit", "Mechanism code", "Mechanism Name",
               "% of Expenditure")
if (uniq_other != 0){
  df_other %>%
  select(-cost_category, -sub_cost_category) %>%
  mutate(perc_exp = percent(perc_exp)) %>%
  kbl(format = "latex", col.names = col_other, booktabs=T,
      caption = 'Mechanisms  with 10 Percent Expenditures as “Other: Other”') %>%
  kable_paper(latex_options= c("hold_position", "scale_down")) %>% 
  collapse_rows (columns = 1:2, valign="top")
}else{
  data.frame(list("No Mechanisms were flagged")) %>% 
  kbl(format = "latex", col.names = list("Note:"))%>%
  kable_paper(latex_options = c("hold_position"))
}


```
# PERCENT OF PROGRAM MANAGEMENT EXPENDITURES
The following mechanisms have 40\% or more of expenditures reported as program management. It is up to the mission to follow up with any of these mechanisms to ensure accuracy and/or understand what specifically is supported under PM and how it contributes to programming as these questions may arise during performance/COP discussions.  Double check for accuracy, if this is accurate then consider reaching out to IP for justification. We want partners to accurately report program management, regardless of percent of expenditures. 

```{r, echo=FALSE}
col_pm <- c("Mechanism Code", "Mechanism Name", "% of PM Expenditure of Total")
if (uniq_pm !=0){
  df_pm %>%
  select(-program) %>%
  mutate(perc_exp = percent(perc_exp)) %>%
  # must change col to characters, to change NaN into hyphen
  mutate(perc_exp = as.character(perc_exp)) %>%
  mutate(perc_exp = case_when(perc_exp == 'NaN'~'-',
                              TRUE ~perc_exp)) %>%
  kbl(format = "latex", col.names = col_pm, longtable=T, booktabs=T,
      caption = "Percent of Program Management Expenditure") %>%
  kable_paper(latex_options= c("hold_position", 'repeat_header')) %>%
  column_spec(1, width = '5em') %>%
  column_spec(2, width = '15em') %>%
  collapse_rows(columns = 1:2, valign="top")
}else{
  data.frame(list("No Mechanisms were flagged")) %>% 
  kbl(format = "latex", col.names = list("Note:"))%>%
  kable_paper(latex_options = c("hold_position"))
}

```
# MER AND EXPENDITURE CROSS DATA VALIDATIONS
Typically, we expect expenditures to align roughly with reported MER indicators (e.g. TX_CURR would indicate C&T expenditures, PrEP_NEW Prev-PrEP expenditures, etc.).  This is not a hard and fast rule, and the flexibility in the PEPFAR financial reporting guidance allows for a “rolling up” into umbrella interventions that may obscure this alignment.  At HQ, we are pushing for more consistency and specificity of reporting so that we can accurately estimate our contributions to all major priorities.   . 
The table below flags if an IM meets a certain threshold of MER results that are reported, but with no corresponding expenditures. It is up to the mission to determine whether any updates to the data are needed within the country context and follow up with any of these mechanisms accordingly. 


```{r, echo=FALSE}
col_cdv <- c("Mechanism Code", "Mechanism Name", " Indicator",
             "Results", "Missing Expenditure Category")
df_cdv <- 
  pmap(list(msd_str_lst, msd_cond, fsd_filter_lst, fsd_str_lst), 
       ~cross_data_check(msd_ou, fsd_ou, msd_filter = ..1, 
                         cond = ..2, fsd_filter = ..3, fsd_str = ..4)) %>%
  bind_rows() %>%
  group_by(indicator)

len_cdv <- length(df_cdv$mech_code)

if (len_cdv !=0){
  df_cdv %>%
  ungroup() %>%
  kbl(format = "latex", col.names = col_cdv, longtable = T, 
      booktabs = T, caption="Mechanisms Flagged for Reporting MER Results but not Related Expenditures") %>%
  kable_paper(latex_options = c("hold_position", "repeat_header",
                                "bordered")) %>%
  column_spec(1, width = '7em') %>%
  column_spec(2, width = '15em') %>%
  pack_rows(index = setNames(rle(df_cdv$indicator)[[1]],
                             rle(df_cdv$indicator)[[2]]),
            color = "white",
            background = "gray" ) %>%
  collapse_rows (columns = 1:2, valign="top")

  # %>%
  # remove_column(columns = 3)
} else{
  data.frame(list("No Mechanisms were flagged")) %>% 
    kbl(format = "latex", col.names = list("Note:"))%>%
    kable_paper(latex_options = c("hold_position"))
}
```
# ENSURING ALL MECHANISMS WHICH REPORTED IN ER ALSO REPORT TO THE NEW HRH INVENTORY
The following table shows which mechanisms have reported in Expenditure Reporting but did not report to the HRH Inventory. All mechanisms which report to ER should also report to the HRH inventory this year.
Have these highlighted mechanisms complete the HRH template and upload their data to the HRH processor app in DATIM during data cleaning (Dec. 1st - 17th).
